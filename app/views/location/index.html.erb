<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title>Where am I?</title>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
		<meta http-equiv="imagetoolbar" content="no" />

		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.1/jquery.min.js" type="text/javascript"></script>

		<script src="/javascripts/gears_init.js"></script>
		<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAABPHC2xpPDspLGjzJeCbOKxTa49wdPbz4vd337zQZaCvLVbL0IBTJB2PsOfNoQtd41zViFgWycG8XMw" type="text/javascript"></script>
		<script type="text/javascript">
		
			$(document).ready(function() {
				if (GBrowserIsCompatible() && (navigator.geolocation || (window.google && google.gears))) {
					queryLocation();
				}
			});

			function queryLocation() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(positionFound, positionNotFound, {enableHighAccuracy: true});
				}
				else if (window.google && google.gears) {
					var geo = google.gears.factory.create('beta.geolocation');
					geo.getCurrentPosition(positionFound_gears, positionNotFound_gears);
				}
			}
	
			function updateMap(latitude, longitude) {
				var map = new GMap2(document.getElementById("map"));
		
				// center map
				var point = new GLatLng(latitude, longitude);
				map.setCenter(point, 14);
				
				// mark found position
		    var marker = new GMarker(point);
		    map.addOverlay(marker);
		
				// resolve address
				var geocoder = new GClientGeocoder();
				geocoder.getLocations(point, function(response) { 
					if (!response || response.Status.code != 200) {
						alert('hmm');
						return;
					}
					
					// $("#user_geo_address").attr("value", response.Placemark[0].address);
					// $("#geo_lat_lng").html("Lat: " + latitude + ", Lng: " + longitude);
				});
			}

			function positionFound_gears(position) {
				updateMap(position.latitude, position.longitude);
			}
	
			function positionNotFound_gears(positionError) {
				positionNotFound();
			}

			function positionFound(position) {
				updateMap(position.coords.latitude, position.coords.longitude);
			}

			function positionNotFound() {
				alert('not found');
			}   

		</script>
		<style type="text/css">
			html, body {
				width: 100%;
				height: 100%;
			}
			html {
				overflow: hidden;
			}
			body {
				margin: 0px 0px 0px 0px;
				padding: 0px;
			}
			#map {
				width: 100%;
				height: 100%;
			}
		</style>
	</head>
	
	<body onunload="GUnload()">
		<div id="map">
			<h1>Hold on!</h1>
			<p>
				I'm trying to figure ou where you are!
			</p>
		</div>
	</body>
</html>